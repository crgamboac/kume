<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="es"
  th:replace="~{shared/layout :: layout(~{::title}, ~{::section})}"
>
  Â  Â 
  <head>
    Â  Â  Â  Â 
    <title th:text="${'Detalles: ' + recipe.name}">Detalles de Receta</title>
    Â  Â 
  </head>
  Â  Â 
  <body>
    Â  Â  Â  Â 
    <section id="content" class="container mt-4">
      <a
        th:href="@{/recipes/list}"
        class="btn btn-sm btn-outline-secondary mb-4"
      >
        <i class="bi bi-arrow-left"></i> Volver al CatÃ¡logo
      </a>

      <div class="social-buttons">
        <a
          th:href="@{'https://twitter.com/intent/tweet?url=' + ${#uris.escapePath(shareUrl)} + '&text=Â¡Mira esta receta! ' + ${recipe.name}}"
          target="_blank"
          class="btn btn-dark"
        >
          Compartir en X (Twitter)
        </a>

        <a
          th:href="@{'https://www.facebook.com/sharer/sharer.php?u=' + ${#uris.escapeQueryParam(shareUrl)}}"
          target="_blank"
          class="btn btn-primary"
        >
          Compartir en Facebook
        </a>

        <a
          th:href="@{'https://api.whatsapp.com/send?text=' + ${#uris.escapePath('Â¡Mira esta receta ' + recipe.name)} + '! - ' + ${#uris.escapePath(shareUrl)}}"
          target="_blank"
          class="btn btn-success"
        >
          Compartir por WhatsApp
        </a>
      </div>

      Â  Â  Â  Â  Â  Â 
      <div class="row">
        Â  Â  Â  Â  Â  Â  Â  Â 
        <div class="col-lg-8">
          Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
          <h1 class="mb-3 text-primary" th:text="${recipe.name}">
            Nombre de la Receta
          </h1>
          <div
            th:with="imgUrl=${recipe.imageUrl.startsWith('http')
        ? recipe.imageUrl
        : '/media/' + recipe.imageUrl}"
          >
            <img
              th:src="@{${imgUrl}}"
              alt="Imagen de la Receta"
              class="img-fluid rounded shadow mb-4"
              style="max-height: 400px; width: 100%; object-fit: cover"
            />
          </div>

          <div class="d-flex flex-wrap gap-2 mb-4">
            <span
              class="badge bg-info text-dark"
              th:text="${'â±ï¸ Tiempo: ' + recipe.cookingTime + ' min'}"
              >90 min</span
            >
            <span
              class="badge bg-success"
              th:text="${'ğŸ… Dificultad: ' + #strings.capitalize(recipe.difficulty.toString().toLowerCase())}"
              >Intermedia</span
            >
            <span
              class="badge bg-warning text-dark"
              th:text="${'ğŸ´ Tipo: ' + recipe.type}"
              >Italiana</span
            >
            <span
              class="badge bg-secondary"
              th:text="${'ğŸŒ Origen: ' + recipe.country}"
              >Italia</span
            >
          </div>

          Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
          <h2 class="mt-4 mb-3">PreparaciÃ³n ğŸ‘¨â€ğŸ³</h2>
          <ol class="list-group list-group-numbered">
            <li
              th:each="step : ${recipe.steps}"
              th:text="${step.instruction}"
              class="list-group-item d-flex justify-content-between align-items-start"
            >
              InstrucciÃ³n del paso 1...
            </li>
          </ol>
          <p th:if="${recipe.steps.isEmpty()}" class="alert alert-info mt-3">
            No se especificaron pasos de preparaciÃ³n.
          </p>
          Â  Â  Â  Â  Â  Â  Â  Â 
        </div>

        Â  Â  Â  Â  Â  Â  Â  Â 
        <div class="col-lg-4">
          <div class="card shadow-sm sticky-top" style="top: 20px">
            <div class="card-header bg-dark text-white">
              <h5 class="mb-0">Ingredientes ğŸ›’</h5>
            </div>
            <ul class="list-group list-group-flush">
              <li th:each="ri : ${recipe.ingredients}" class="list-group-item">
                <span class="fw-bold" th:text="${ri.quantity} + ' '"
                  >500 g</span
                >
                <span th:text="${ri.ingredient.name}">de harina</span>
              </li>
            </ul>
            <p
              th:if="${recipe.ingredients.isEmpty()}"
              class="card-body alert alert-info m-0"
            >
              No se especificaron ingredientes.
            </p>
          </div>
          Â  Â  Â  Â  Â  Â  Â  Â 
        </div>
        <div class="row mt-4" th:if="${not #lists.isEmpty(extraImages)}">
          <div class="col-12">
            <h3>GalerÃ­a</h3>
          </div>

          <div
            class="col-md-4 mb-3"
            th:each="img : ${extraImages}"
            th:with="imgUrl=${img.startsWith('http')
            ? img
            : '/media/' + img}"
          >
            <img
              th:src="@{${imgUrl}}"
              class="img-fluid rounded shadow"
              style="height: 250px; width: 100%; object-fit: cover"
            />
          </div>
        </div>

        <div class="col-lg-4 mt-4">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">ValoraciÃ³n â­</h5>
            </div>

            <div class="card-body">
              <!-- Promedio -->
              <h3 class="text-center mb-3">
                <span
                  th:text="${recipe.averageRating != null ? #numbers.formatDecimal(recipe.averageRating, 1, 2) : '0.0'}"
                  >4.5</span
                >
                <small class="text-muted">/ 5</small>
              </h3>

              <hr />

              <!-- Conteos por estrella -->
              <div>
                <div
                  th:each="i : ${#numbers.sequence(5,1)}"
                  class="d-flex justify-content-between"
                >
                  <div><span th:text="${i}">5</span> â­</div>
                  <strong th:text="${recipe.ratingCounts.get(i)}">0</strong>
                </div>
              </div>

              <hr />

              <!-- Valor del usuario -->
              <div class="mt-2">
                <p th:if="${recipe.userRating != null}">
                  Tu valoraciÃ³n:
                  <strong th:text="${recipe.userRating} + ' â­'"></strong>
                </p>

                <p th:if="${recipe.userRating == null}" class="text-muted">
                  AÃºn no has valorado esta receta.
                </p>
              </div>

              <!-- Formulario -->
              <form
                th:action="@{/recipes/{id}/rate(id=${recipe.id})}"
                method="post"
                class="mt-3"
              >
                <select name="stars" class="form-select mb-2" required>
                  <option value="">Selecciona estrellas</option>

                  <option
                    th:each="i : ${#numbers.sequence(1,5)}"
                    th:value="${i}"
                    th:text="${i + ' â­'}"
                  ></option>
                </select>

                <button type="submit" class="btn btn-primary w-100">
                  Guardar valoraciÃ³n
                </button>
              </form>
            </div>
          </div>
        </div>
        <hr class="my-5" />

        <h2 class="mb-3">Comentarios ğŸ’¬</h2>
        <!-- Formulario para crear comentario nuevo -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <form
              th:action="@{/recipes/{id}/comments(id=${recipe.id})}"
              method="post"
            >
              <input type="hidden" name="userId" value="1" />
              <!-- SimulaciÃ³n temporal -->

              <div class="mb-3">
                <textarea
                  name="content"
                  rows="3"
                  class="form-control"
                  placeholder="Escribe tu comentario..."
                  required
                ></textarea>
              </div>

              <button class="btn btn-primary" type="submit">Comentar</button>
            </form>
          </div>
        </div>

        <!-- Renderizar comentarios -->
        <div
          th:replace="~{recipe/recipe-comments :: commentList(comments=${comments}, recipeId=${recipe.id})}"
        ></div>
      </div>
      Â  Â  Â  Â 
    </section>
    Â  Â 
  </body>
</html>
